'''–ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª pytest.
–°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤.'''

import pytest
import logging
import sys
from datetime import datetime, timedelta
from faker import Faker

from core.clients.api_client import APIClient


# ========== –ü–†–û–°–¢–ï–ô–®–ï–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï (3 —Å—Ç—Ä–æ–∫–∏) ==========
# logging - –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Python, –Ω–∏—á–µ–≥–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ
# basicConfig - –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
# level=logging.INFO - –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤—ã—à–µ (WARNING, ERROR)
#                    - –µ—Å–ª–∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å DEBUG, –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –í–°–Å
# format - –∫–∞–∫ –±—É–¥—É—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –ª–æ–≥–∏: –≤—Ä–µ–º—è | —Å–æ–æ–±—â–µ–Ω–∏–µ
# handlers - –∫—É–¥–∞ –≤—ã–≤–æ–¥–∏—Ç—å –ª–æ–≥–∏ (–≤ –∫–æ–Ω—Å–æ–ª—å)
logging.basicConfig(
    level=logging.INFO,  # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –º–µ–Ω—è–π—Ç–µ –Ω–∞ logging.DEBUG
    format='%(asctime)s | %(name)-25s | %(levelname)-8s | %(message)s',  # –ü—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç: –≤—Ä–µ–º—è | –∏–º—è –º–æ–¥—É–ª—è.
    # –¶–∏—Ñ—Ä–∞ -25 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ–¥ –∏–º—è —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç—Å—è 25 —Å–∏–º–≤–æ–ª–æ–≤, –∞ —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –≤—ã—Ä–æ–≤–Ω–µ–Ω –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é | –¢–µ–∫—Å—Ç–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
    # —É—Ä–æ–≤–Ω—è (INFO, DEBUG –∏ —Ç.–¥.). –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç—Å—è 8 —Å–∏–º–≤–æ–ª–æ–≤. | —Å–æ–æ–±—â–µ–Ω–∏–µ
    handlers=[logging.StreamHandler(sys.stdout)]  # –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
)

# –°–æ–∑–¥–∞—ë–º –ª–æ–≥–≥–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
# __name__ - —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, —Ä–∞–≤–Ω–∞ "conftest"
logger = logging.getLogger(__name__)
# =======================================================


@pytest.fixture(scope='session')
def api_client():
    '''–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è API –∫–ª–∏–µ–Ω—Ç–∞.
    scope='session' - —Å–æ–∑–¥–∞—ë—Ç—Å—è –û–î–ò–ù –†–ê–ó –∑–∞ –≤—Å–µ —Ç–µ—Å—Ç—ã.'''

    logger.info("=" * 50)
    logger.info("üöÄ –ù–ê–ß–ê–õ–û –¢–ï–°–¢–û–í–û–ô –°–ï–°–°–ò–ò")
    logger.info("=" * 50)

    # –°–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç
    client = APIClient()

    # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—Å—è
    logger.info("üîë –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è...")
    client.auth()
    logger.info("‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞")

    # yield - –æ—Ç–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç —Ç–µ—Å—Ç–∞–º
    yield client

    # –ö–æ–¥ –ø–æ—Å–ª–µ yield –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ –í–°–ï–• —Ç–µ—Å—Ç–æ–≤
    logger.info("=" * 50)
    logger.info("üèÅ –ó–ê–í–ï–†–®–ï–ù–ò–ï –¢–ï–°–¢–û–í–û–ô –°–ï–°–°–ò–ò")
    logger.info("=" * 50)



@pytest.fixture
def booking_dates():
    '''–§–∏–∫—Å—Ç—É—Ä–∞ —Å –¥–∞—Ç–∞–º–∏'''
    today = datetime.today()
    checkin_date = today + timedelta(days=10)
    checkout_date = checkin_date + timedelta(days=5)

    return {
        'checkin': checkin_date.strftime('%Y-%m-%d'),
        'checkout': checkout_date.strftime('%Y-%m-%d')
    }


@pytest.fixture()
def generate_random_booking_data(booking_dates):
    '''–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É Faker –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è:
    - —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–º—ë–Ω –∏ —Ñ–∞–º–∏–ª–∏–π
    - —Å–ª—É—á–∞–π–Ω—ã—Ö —Ü–µ–Ω
    - —Å–ª—É—á–∞–π–Ω—ã—Ö –±—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π'''
    fake = Faker()

    data = {
        'firstname': fake.first_name(),
        'lastname': fake.last_name(),
        'totalprice': fake.random_int(100, 999),
        'depositpaid': fake.boolean(),
        'bookingdates': booking_dates,
        'additionalneeds': fake.sentence()
    }

    # –õ–æ–≥–∏—Ä—É–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—É—Ä–æ–≤–µ–Ω—å DEBUG - –≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–∏–ª–∏ DEBUG)
    logger.debug(f"üìù –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: {data}")
    return data
